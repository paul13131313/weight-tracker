<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‰ΩìÈáç</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@900&family=DM+Sans:wght@500;700;800&family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --card-bg: #fffdf7;
      --card-border: rgba(120,80,20,0.08);
      --text-dark: #2c1810;
      --text-mid: #6b4c35;
      --text-light: #a08060;
      --accent: #c0392b;
      --success: #2d8f4e;
      --danger: #c0392b;
      --mustard: #e8b930;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { width: 100%; overflow-x: hidden; }
    body { font-family: 'Noto Sans JP', 'DM Sans', sans-serif; background: var(--mustard); color: var(--text-dark); }
    .header { padding: 16px 0 4px; text-align: center; }
    .header h1 { font-family: 'Noto Serif JP', serif; font-weight: 900; font-size: 30vw; letter-spacing: 0.06em; line-height: 1.0; color: var(--accent); transform: scaleY(0.78); transform-origin: center; }
    .header .sub { font-size: 3.5vw; color: rgba(90, 50, 10, 0.5); letter-spacing: 0.15em; font-weight: 400; }
    .main { padding: 8px 4px 16px; }
    .section-label { font-size: 3vw; font-weight: 700; color: var(--text-light); letter-spacing: 0.1em; margin-bottom: 5px; padding-left: 4px; }
    .card { background: var(--card-bg); border-radius: 10px; padding: 8px 4px; margin-bottom: 8px; border: 1px solid var(--card-border); box-shadow: 0 2px 8px rgba(80,40,0,0.06); }
    .member-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
    .member-card { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 6px 2px; background: #fdf6eb; border-radius: 10px; border: 1px solid rgba(120,80,20,0.05); text-align: center; }
    .member-icon { width: 10vw; height: 10vw; max-width: 44px; max-height: 44px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); flex-shrink: 0; }
    .member-icon-placeholder { width: 10vw; height: 10vw; max-width: 44px; max-height: 44px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 4vw; flex-shrink: 0; }
    .member-info { min-width: 0; width: 100%; text-align: center; }
    .member-name-row { display: flex; align-items: center; justify-content: center; gap: 1px; }
    .member-name { font-weight: 600; font-size: 3vw; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .edit-btn { background: none; border: none; cursor: pointer; font-size: 2.8vw; color: var(--text-light); padding: 1px; line-height: 1; min-width: 20px; min-height: 20px; display: flex; align-items: center; justify-content: center; }
    .edit-btn:active { background: rgba(0,0,0,0.05); border-radius: 4px; }
    .member-weight-area { display: flex; align-items: baseline; justify-content: center; gap: 1px; }
    .member-latest { font-family: 'DM Sans', sans-serif; font-size: 5vw; font-weight: 800; color: var(--text-dark); line-height: 1.2; }
    .member-latest-unit { font-size: 2.5vw; color: var(--text-light); font-weight: 500; }
    .member-change { font-size: 2.5vw; font-weight: 700; }
    .change-down { color: var(--success); }
    .change-down::before { content: '‚ñº'; font-size: 1.8vw; margin-right: 1px; }
    .change-up { color: var(--danger); }
    .change-up::before { content: '‚ñ≤'; font-size: 1.8vw; margin-right: 1px; }
    .change-same { color: var(--text-light); }
    .chart-container { position: relative; width: 100%; height: 120vw; min-height: 440px; }
    .refresh-btn { display: block; width: 100%; margin: 6px 0 0; padding: 12px; background: var(--card-bg); color: var(--text-dark); border: 1px solid var(--card-border); border-radius: 10px; font-size: 3.8vw; font-weight: 700; cursor: pointer; font-family: inherit; box-shadow: 0 2px 6px rgba(80,40,0,0.05); }
    .refresh-btn:active { background: #fdf6eb; transform: scale(0.98); }
    .last-updated { text-align: center; font-size: 2.8vw; color: var(--text-light); margin-top: 6px; }
    .loading { text-align: center; padding: 40px 12px; color: var(--text-light); }
    .loading-spinner { width: 24px; height: 24px; border: 3px solid #eee; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; margin: 0 auto 10px; }
    .loading p { font-size: 3.8vw; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error { text-align: center; padding: 24px 12px; color: var(--danger); font-size: 3.8vw; }

    /* „É¢„Éº„ÉÄ„É´ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); z-index: 1000; align-items: flex-end; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--card-bg); border-radius: 16px 16px 0 0; padding: 16px 12px 28px; width: 100%; animation: slideUp 0.22s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-handle { width: 32px; height: 4px; background: #ddd; border-radius: 2px; margin: 0 auto 14px; }
    .modal h3 { font-size: 4.5vw; margin-bottom: 14px; font-weight: 700; }
    .modal label { display: block; font-size: 3.2vw; color: var(--text-light); margin-bottom: 4px; margin-top: 12px; font-weight: 600; }
    .modal input[type="text"] { width: 100%; padding: 10px 12px; border: 1.5px solid rgba(120,80,20,0.12); border-radius: 10px; font-size: 16px; outline: none; background: #fdf6eb; color: var(--text-dark); font-family: inherit; -webkit-appearance: none; }
    .modal input[type="text"]:focus { border-color: var(--accent); background: #fffdf7; }

    /* „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Éú„Çø„É≥ */
    .upload-area { margin-top: 12px; }
    .upload-row { display: flex; gap: 8px; align-items: center; }
    .upload-btn { display: inline-flex; align-items: center; gap: 4px; padding: 8px 14px; background: #fdf6eb; border: 1.5px dashed rgba(120,80,20,0.2); border-radius: 10px; font-size: 3.5vw; color: var(--text-mid); cursor: pointer; font-family: inherit; font-weight: 600; transition: background 0.15s; }
    .upload-btn:active { background: #f5ece0; }
    .upload-btn input[type="file"] { display: none; }
    .upload-status { font-size: 3vw; color: var(--text-light); }
    .upload-status.uploading { color: var(--accent); }
    .upload-status.done { color: var(--success); }
    .upload-status.error { color: var(--danger); }
    .or-divider { font-size: 3vw; color: var(--text-light); margin-top: 8px; text-align: center; }

    .modal-preview { display: flex; align-items: center; gap: 8px; margin-top: 12px; padding: 10px; background: #fdf6eb; border-radius: 8px; }
    .modal-preview img { width: 34px; height: 34px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
    .modal-preview .preview-placeholder { width: 34px; height: 34px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; color: var(--text-light); font-size: 14px; font-weight: 700; }
    .modal-preview .preview-name { font-weight: 700; font-size: 3.8vw; }
    .modal-buttons { display: flex; gap: 8px; margin-top: 16px; }
    .modal-buttons button { flex: 1; padding: 12px; border-radius: 10px; font-size: 4vw; font-weight: 700; cursor: pointer; border: none; font-family: inherit; min-height: 44px; }
    .btn-cancel { background: #f5ece0; color: var(--text-mid); }
    .btn-save { background: var(--accent); color: white; }
    .btn-save:disabled { opacity: 0.4; }
    .saving-text { text-align: center; color: var(--accent); font-size: 3.2vw; margin-top: 6px; display: none; }

    @media (min-width: 601px) {
      .header h1 { font-size: 100px; }
      .header .sub { font-size: 13px; }
      .main { padding: 10px 16px 24px; max-width: 600px; margin: 0 auto; }
      .card { border-radius: 12px; padding: 12px; }
      .section-label { font-size: 11px; }
      .member-name { font-size: 13px; }
      .member-latest { font-size: 22px; }
      .member-latest-unit { font-size: 11px; }
      .member-change { font-size: 11px; }
      .change-down::before, .change-up::before { font-size: 8px; }
      .member-icon, .member-icon-placeholder { width: 40px; height: 40px; max-width: none; max-height: none; }
      .member-icon-placeholder { font-size: 16px; }
      .chart-container { height: 400px; }
      .refresh-btn { font-size: 14px; max-width: 260px; margin: 8px auto 0; }
      .last-updated { font-size: 11px; }
      .edit-btn { font-size: 14px; }
      .modal { max-width: 420px; border-radius: 16px; margin-bottom: 20px; padding: 20px 20px 28px; }
      .modal-overlay { align-items: center; }
      .upload-btn { font-size: 14px; }
      .upload-status { font-size: 12px; }
      .or-divider { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>‰ΩìÈáç</h1>
    <div class="sub">LINE„Ç∞„É´„Éº„ÉóËá™ÂãïË®òÈå≤</div>
  </div>
  <div class="main">
    <div id="members-card" style="display:none;">
      <div class="section-label">„É°„É≥„Éê„Éº</div>
      <div class="card">
        <div class="member-list" id="member-list"></div>
      </div>
    </div>
    <div style="margin-top:8px;">
      <div class="card">
        <div id="loading" class="loading"><div class="loading-spinner"></div><p>Ë™≠„ÅøËæº„Åø‰∏≠...</p></div>
        <div id="error" class="error" style="display:none;"><p>„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p><br><button class="refresh-btn" onclick="loadData()">ÂÜçË™≠„ÅøËæº„Åø</button></div>
        <div class="chart-container" id="chart-container" style="display:none;"><canvas id="weightChart"></canvas></div>
      </div>
    </div>
    <button class="refresh-btn" onclick="loadData()">„Éá„Éº„ÇøÊõ¥Êñ∞</button>
    <div class="last-updated" id="last-updated"></div>
  </div>

  <!-- „É°„É≥„Éê„ÉºË®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-handle"></div>
      <h3>„É°„É≥„Éê„ÉºË®≠ÂÆö</h3>

      <label>Ë°®Á§∫Âêç</label>
      <input type="text" id="editName" placeholder="Ë°®Á§∫„Åô„ÇãÂêçÂâç" oninput="updatePreview()">

      <div class="upload-area">
        <label>„Ç¢„Ç§„Ç≥„É≥ÁîªÂÉè</label>
        <div class="upload-row">
          <label class="upload-btn">
            üì∑ ÁîªÂÉè„ÇíÈÅ∏Êäû
            <input type="file" id="iconFile" accept="image/*" onchange="handleFileSelect(this)">
          </label>
          <span class="upload-status" id="uploadStatus"></span>
        </div>
        <div class="or-divider">„Åæ„Åü„ÅØ URL „ÇíÁõ¥Êé•ÂÖ•Âäõ</div>
      </div>

      <label>„Ç¢„Ç§„Ç≥„É≥URL</label>
      <input type="text" id="editIcon" placeholder="https://..." oninput="updatePreview()">

      <div class="modal-preview" id="editPreview">
        <div class="preview-placeholder" id="previewIcon">?</div>
        <span class="preview-name" id="previewName">„Éó„É¨„Éì„É•„Éº</span>
      </div>
      <div class="saving-text" id="savingText">‰øùÂ≠ò‰∏≠...</div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn-save" id="saveBtn" onclick="saveSetting()">‰øùÂ≠ò„Åô„Çã</button>
      </div>
    </div>
  </div>

  <script>
    // ‚òÖ GAS„Ç¶„Çß„Éñ„Ç¢„Éó„É™URL
    var GAS_API_URL = 'https://script.google.com/macros/s/AKfycbz71_j4dMTTNRUWptZIGnHnqPuKFrT2OpF1ZPxllEfnRbrvitdeOMKF3XwU_kNd_ywo/exec';

    var COLORS=[{line:'#c0392b',bg:'rgba(192,57,43,0.08)'},{line:'#d4740a',bg:'rgba(212,116,10,0.08)'},{line:'#2d8f4e',bg:'rgba(45,143,78,0.08)'},{line:'#8e5435',bg:'rgba(142,84,53,0.08)'},{line:'#b5651d',bg:'rgba(181,101,29,0.08)'},{line:'#7a3b2e',bg:'rgba(122,59,46,0.08)'}];
    var chart=null,currentData=null,editingMember=null;

    function loadData(){
      document.getElementById('loading').style.display='block';
      document.getElementById('error').style.display='none';
      document.getElementById('chart-container').style.display='none';
      document.getElementById('members-card').style.display='none';
      fetch(GAS_API_URL+'?action=getData')
        .then(function(r){return r.json();})
        .then(onDataLoaded)
        .catch(onError);
    }
    function onDataLoaded(data){
      document.getElementById('loading').style.display='none';
      currentData=data;
      if(!data||data.length===0){document.getElementById('error').style.display='block';document.getElementById('error').querySelector('p').textContent='„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';return;}
      var members={};
      data.forEach(function(r){var k=r.originalMember||r.member;if(!members[k])members[k]={originalMember:k,displayName:r.member,iconUrl:r.iconUrl,data:[]};members[k].data.push({date:r.date,weight:r.weight});if(r.iconUrl)members[k].iconUrl=r.iconUrl;members[k].displayName=r.member;});
      renderCards(members);renderChart(members);
      document.getElementById('last-updated').textContent='ÊúÄÁµÇÊõ¥Êñ∞ '+new Date().toLocaleString('ja-JP');
    }
    function onError(){document.getElementById('loading').style.display='none';document.getElementById('error').style.display='block';}
    function renderCards(members){
      var c=document.getElementById('member-list');c.innerHTML='';
      Object.keys(members).forEach(function(k){
        var m=members[k],l=m.data[m.data.length-1],p=m.data.length>1?m.data[m.data.length-2]:null;
        var ch='';
        if(p){var d=(l.weight-p.weight).toFixed(1);var cl=d<0?'change-down':d>0?'change-up':'change-same';ch='<span class="member-change '+cl+'">'+(d>0?'+':'')+d+'kg</span>';}
        var dn=m.displayName,fc=dn.charAt(0);
        var ih=m.iconUrl?'<img class="member-icon" src="'+m.iconUrl+'" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'"><div class="member-icon-placeholder" style="display:none">'+fc+'</div>':'<div class="member-icon-placeholder">'+fc+'</div>';
        var el=document.createElement('div');el.className='member-card';
        el.innerHTML=ih+'<div class="member-info"><div class="member-name-row"><span class="member-name">'+dn+'</span><button class="edit-btn" onclick="openEditModal(\''+esc(m.originalMember)+'\',\''+esc(dn)+'\',\''+esc(m.iconUrl||'')+'\')">‚úèÔ∏è</button></div><div class="member-weight-area"><span class="member-latest">'+l.weight+'</span><span class="member-latest-unit">kg</span></div>'+ch+'</div>';
        c.appendChild(el);
      });
      document.getElementById('members-card').style.display='block';
    }
    function esc(s){return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"');}
    function renderChart(members){
      var ad=[];Object.keys(members).forEach(function(k){members[k].data.forEach(function(d){if(ad.indexOf(d.date)===-1)ad.push(d.date);});});ad.sort();
      var ds=[];
      Object.keys(members).forEach(function(k,i){var co=COLORS[i%COLORS.length],m=members[k],dm={};m.data.forEach(function(d){dm[d.date]=d.weight;});
        ds.push({label:m.displayName,data:ad.map(function(dt){return dm[dt]!==undefined?dm[dt]:null;}),borderColor:co.line,backgroundColor:co.bg,borderWidth:2.5,pointRadius:6,pointBackgroundColor:co.line,pointBorderColor:'#fff',pointBorderWidth:2,tension:0.35,fill:true,spanGaps:true});});
      var lb=ad.map(function(d){var p=d.split('-');return parseInt(p[1])+'/'+parseInt(p[2]);});
      if(chart)chart.destroy();
      chart=new Chart(document.getElementById('weightChart').getContext('2d'),{type:'line',data:{labels:lb,datasets:ds},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:10,font:{size:12,family:"'Noto Sans JP'"},color:'#8a7060'}},tooltip:{backgroundColor:'#fff',titleColor:'#333',bodyColor:'#333',titleFont:{size:12},bodyFont:{size:14,weight:700},padding:10,cornerRadius:8,borderColor:'rgba(0,0,0,0.1)',borderWidth:1,callbacks:{label:function(ctx){return ' '+ctx.dataset.label+': '+ctx.parsed.y+'kg';}}}},scales:{x:{grid:{display:false},ticks:{font:{size:11},color:'#b09070'}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{size:11},color:'#b09070',callback:function(v){return v+'kg';}}}},interaction:{intersect:false,mode:'index'}}});
      document.getElementById('chart-container').style.display='block';
    }

    // ===== „É¢„Éº„ÉÄ„É´ =====
    function openEditModal(o,n,ic){
      editingMember={originalMember:o,currentName:n,currentIcon:ic};
      document.getElementById('editName').value=n;
      document.getElementById('editIcon').value=ic;
      document.getElementById('iconFile').value='';
      document.getElementById('uploadStatus').textContent='';
      document.getElementById('uploadStatus').className='upload-status';
      document.getElementById('savingText').style.display='none';
      document.getElementById('saveBtn').disabled=false;
      updatePreview();
      document.getElementById('editModal').classList.add('active');
    }
    function closeModal(){document.getElementById('editModal').classList.remove('active');editingMember=null;}
    function updatePreview(){
      var n=document.getElementById('editName').value||'?';
      var ic=document.getElementById('editIcon').value;
      document.getElementById('previewName').textContent=n;
      var el=document.getElementById('previewIcon');
      el.innerHTML=ic?'<img src="'+ic+'" style="width:34px;height:34px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)" onerror="this.parentElement.innerHTML=\''+n.charAt(0)+'\'">':n.charAt(0);
    }

    // ===== ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ =====
    function handleFileSelect(input){
      var file=input.files[0];
      if(!file)return;

      // „Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà2MBÂà∂ÈôêÔºâ
      if(file.size>2*1024*1024){
        var st=document.getElementById('uploadStatus');
        st.textContent='2MB‰ª•‰∏ã„ÅÆÁîªÂÉè„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ';
        st.className='upload-status error';
        return;
      }

      var st=document.getElementById('uploadStatus');
      st.textContent='„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...';
      st.className='upload-status uploading';
      document.getElementById('saveBtn').disabled=true;

      var reader=new FileReader();
      reader.onload=function(e){
        var base64Full=e.target.result; // data:image/png;base64,xxxxx
        var parts=base64Full.split(',');
        var mimeMatch=parts[0].match(/data:(.*?);/);
        var mimeType=mimeMatch?mimeMatch[1]:'image/png';
        var base64Data=parts[1];

        fetch(GAS_API_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            action:'uploadIcon',
            base64Data:base64Data,
            mimeType:mimeType,
            fileName:file.name||'icon.png'
          })
        })
        .then(function(r){return r.json();})
        .then(function(result){
          if(result.url){
            document.getElementById('editIcon').value=result.url;
            st.textContent='‚úÖ „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫Ü';
            st.className='upload-status done';
            updatePreview();
          } else {
            st.textContent='‚ùå '+( result.error||'„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó');
            st.className='upload-status error';
          }
          document.getElementById('saveBtn').disabled=false;
        })
        .catch(function(err){
          st.textContent='‚ùå „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó';
          st.className='upload-status error';
          document.getElementById('saveBtn').disabled=false;
        });
      };
      reader.readAsDataURL(file);
    }

    // ===== ‰øùÂ≠ò =====
    function saveSetting(){
      if(!editingMember)return;
      var dn=document.getElementById('editName').value.trim();
      var iu=document.getElementById('editIcon').value.trim();
      if(!dn){alert('Ë°®Á§∫Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');return;}
      document.getElementById('saveBtn').disabled=true;
      document.getElementById('savingText').style.display='block';

      fetch(GAS_API_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          action:'saveMemberSetting',
          originalName:editingMember.originalMember,
          displayName:dn,
          iconUrl:iu
        })
      })
      .then(function(r){return r.json();})
      .then(function(){closeModal();loadData();})
      .catch(function(e){alert('‰øùÂ≠òÂ§±Êïó: '+e);document.getElementById('saveBtn').disabled=false;document.getElementById('savingText').style.display='none';});
    }

    document.getElementById('editModal').addEventListener('click',function(e){if(e.target===this)closeModal();});
    loadData();
  </script>
</body>
</html>
